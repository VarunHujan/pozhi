// ==========================================
// MALWARE SCANNING MIDDLEWARE
// ==========================================
// Scans uploaded files for malware using ClamAV
// Blocks infected files before they reach storage

import { Request, Response, NextFunction } from 'express';
import NodeClam from 'clamscan';
import { ApiError } from '../utils/ApiError';
import { logger } from '../utils/logger';
import { logSecurityEvent } from '../utils/securityLogger';

// ==========================================
// CLAM AV CONFIGURATION
// ==========================================

let clamScan: any = null;
let isInitialized = false;

/**
 * Initialize ClamAV scanner
 * Falls back to no-op if ClamAV is not installed (development mode)
 */
const initClamScan = async () => {
    if (isInitialized) return;

    // Skip on Windows/Mac if not configured
    if (process.platform === 'win32' || process.platform === 'darwin') {
        logger.warn('‚ö†Ô∏è ClamAV: Skipping initialization on Windows/Mac (Dev Mode)');
        isInitialized = true;
        return;
    }

    try {
        // On Windows/Mac without ClamAV, this might throw or fail
        // We want to avoid hardcrashing the app
        const ClamScan = new NodeClam().init({
            removeInfected: false, // Don't auto-delete, just reject
            quarantineInfected: false,
            // scanLog: 'logs/clamscan.log', // Can cause issues if file/permissions missing
            debugMode: false, // Turn off debug to reduce noise
            clamscan: {
                path: '/usr/bin/clamscan', // Linux path
                scanArchives: true,
                active: true
            },
            clamdscan: {
                path: '/usr/bin/clamdscan', // Linux path
                active: true,
                multiscan: true
            },
            preference: 'clamdscan'
        } as any);

        clamScan = await ClamScan;
        isInitialized = true;
        logger.info('‚úÖ ClamAV initialized successfully');
    } catch (error: any) {
        // Suppress the error and just warn
        logger.warn('‚ö†Ô∏è ClamAV not available, malware scanning disabled (Dev Mode)');
        // Don't throw - allow app to run without ClamAV in development
        isInitialized = true; // Mark as "initialized" to prevent retry loops
    }
};

// Initialize on module load
initClamScan();

// ==========================================
// MALWARE SCANNING MIDDLEWARE
// ==========================================

/**
 * Scan uploaded files for malware
 * Rejects requests if malware is detected
 */
export const scanForMalware = async (
    req: Request,
    res: Response,
    next: NextFunction
) => {
    try {
        // Skip if no files uploaded
        if (!req.files || (Array.isArray(req.files) && req.files.length === 0)) {
            return next();
        }

        // Get files array
        const files = Array.isArray(req.files) ? req.files : [req.files];

        // If ClamAV is not available, skip scanning but log warning
        if (!clamScan) {
            logger.warn('Malware scan skipped - ClamAV not available', {
                fileCount: files.length,
                userId: req.user?.id
            });
            return next();
        }

        logger.info('üîç Scanning files for malware...', {
            fileCount: files.length,
            userId: req.user?.id
        });

        // Scan each file
        for (const file of files) {
            const startTime = Date.now();

            // Scan file buffer
            const { isInfected, viruses } = await clamScan.scanBuffer(
                (file as any).buffer,
                3000, // 3 second timeout per file
                10 * 1024 * 1024 // 10MB max file size for scanning
            );

            const scanTime = Date.now() - startTime;

            if (isInfected) {
                // Log security event
                await logSecurityEvent({
                    type: 'malware_detected',
                    user_id: req.user?.id,
                    ip: req.ip || 'unknown',
                    user_agent: req.get('user-agent') || 'unknown',
                    details: {
                        filename: (file as any).originalname,
                        viruses: viruses || [],
                        fileSize: (file as any).size,
                        scanTime
                    }
                });

                logger.error('üö® MALWARE DETECTED in upload!', {
                    filename: (file as any).originalname,
                    viruses: viruses || [],
                    userId: req.user?.id,
                    ip: req.ip,
                    scanTime: `${scanTime}ms`
                });

                throw new ApiError(
                    400,
                    `Malware detected in file "${(file as any).originalname}". Upload rejected for security reasons.`
                );
            }

            logger.info('‚úÖ File scan clean', {
                filename: (file as any).originalname,
                scanTime: `${scanTime}ms`
            });
        }

        logger.info('‚úÖ All files passed malware scan', {
            fileCount: files.length,
            userId: req.user?.id
        });

        next();
    } catch (error: any) {
        // If it's our ApiError, pass it through
        if (error instanceof ApiError) {
            return next(error);
        }

        // Log unexpected scan errors
        logger.error('Malware scan error:', {
            error: error.message,
            stack: error.stack,
            userId: req.user?.id
        });

        // In production, reject on scan errors (fail-secure)
        if (process.env.NODE_ENV === 'production') {
            throw new ApiError(
                500,
                'File security scan failed. Please try again later.'
            );
        }

        // In development, allow through with warning
        logger.warn('‚ö†Ô∏è Allowing upload despite scan error (development mode)');
        next();
    }
};

// ==========================================
// HEALTH CHECK
// ==========================================

/**
 * Check if ClamAV is available and virus definitions are up to date
 */
export const checkClamAvHealth = async (): Promise<{
    available: boolean;
    version?: string;
    definitionsDate?: string;
}> => {
    if (!clamScan) {
        return { available: false };
    }

    try {
        const version = await clamScan.getVersion();
        return {
            available: true,
            version: version.version || 'unknown'
        };
    } catch (error) {
        return { available: false };
    }
};

export default {
    scanForMalware,
    checkClamAvHealth
};
